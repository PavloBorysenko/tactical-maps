{% extends 'base.html.twig' %}

{% block title %}{{ observer.name }} - Observer View{% endblock %}

{% block body %}
<div class="observer-viewer-page">
    <div class="container-fluid py-3">
        <div class="row">
            <div class="col-12">
                <!-- Observer Information Panel -->
                <div class="observer-info-panel">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2>
                                {% if observer.icon %}
                                    <img src="{{ observer.icon }}" alt="Observer icon">
                                {% endif %}
                                {{ observer.name }}
                            </h2>
                            {% if observer.description %}
                                <p>{{ observer.description }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="observer-stats">
                                <strong>Map:</strong> {{ map.title }}<br>
                                <small><span data-objects-count>{{ geoObjects|length }}</span> active objects</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Map Information Bar -->
                <div class="map-info-bar">
                    <div>
                        <strong>{{ map.title }}</strong>
                        {% if map.description %}
                            - {{ map.description }}
                        {% endif %}
                    </div>
                    <div>
                        <small>
                            <i class="fas fa-eye"></i> Observer View
                        </small>
                    </div>
                </div>
                
                <!-- Map Container -->
                <div id="map-container" class="map-container"
                     data-map-id="{{ map.id }}" 
                     data-map-center-lat="{{ map.centerLat }}" 
                     data-map-center-lng="{{ map.centerLng }}" 
                     data-map-zoom="{{ map.zoomLevel }}"
                     data-observer-mode="true"
                     data-observer-token="{{ observer.accessToken }}"
                     data-geo-objects="{{ geoObjects|map(obj => {
                         'id': obj.id,
                         'hash': obj.hash,
                         'title': obj.name,
                         'description': obj.description,
                         'type': obj.geometryType,
                         'geoJson': obj.geometry,
                         'ttl': obj.ttl,
                         'iconUrl': obj.iconUrl,
                         'side': obj.side ? {
                             'id': obj.side.id,
                             'name': obj.side.name,
                             'color': obj.side.color
                         } : null,
                         'sideId': obj.side ? obj.side.id : null,
                         'isExpired': obj.isExpired,
                         'remainingTtl': obj.remainingTtl,
                         'createdAt': obj.createdAt ? obj.createdAt.format('Y-m-d H:i:s') : null,
                         'updatedAt': obj.updatedAt ? obj.updatedAt.format('Y-m-d H:i:s') : null
                     })|json_encode|e('html_attr') }}">
                </div>
                
                <!-- Observer Status -->
                <div class="observer-status mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <small>
                                <i class="fas fa-clock"></i> 
                                Connected since: {{ observer.createdAt|date('Y-m-d H:i:s') }}
                            </small>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <small>
                                <i class="fas fa-map-marker-alt"></i> 
                                Objects with active TTL: <span data-objects-count>{{ geoObjects|length }}</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    {{ encore_entry_script_tags('observerMapViewer') }}
    {{ encore_entry_script_tags('observerViewerPage') }}
{% endblock %} 